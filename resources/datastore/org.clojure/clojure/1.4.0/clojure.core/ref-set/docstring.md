  Must be called in a transaction. Sets the value of ref.
  Returns val.